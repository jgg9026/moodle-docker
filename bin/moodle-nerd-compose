#!/usr/bin/env bash
set -e
# Patch: Handle env variables differently.
B_DIR=$( cd -- "$( dirname -- "${BASH_SOURCE[0]}" )" &> /dev/null && pwd )
source "${B_DIR}/../project_config.sh"
cp "${B_DIR}/../config.docker-template.php" $MOODLE_DOCKER_WWWROOT/config.php
# Rancher lacks support for environment variables, this can be used instead. Not elegant BTW.
echo "MOODLE_DOCKER_WWWROOT=/Users/jonathan.garcia/Documents/core-moodle" > temp.env
echo "MOODLE_DOCKER_DB=mysql" >> temp.env
echo "MOODLE_DOCKER_DBNAME=m4.0" >> temp.env
echo "MOODLE_DOCKER_WEB_HOST=moodle.test" >> temp.env
echo "MOODLE_DOCKER_WEB_PORT=80" >> temp.env
echo "MOODLE_DOCKER_BROWSER=firefox:3" >> temp.env
# End of patch.
if [ ! -d "$MOODLE_DOCKER_WWWROOT" ];
then
    echo 'Error: $MOODLE_DOCKER_WWWROOT is not set or not an existing directory'
    exit 1
fi

if [ -z "$MOODLE_DOCKER_DB" ];
then
    echo 'Error: $MOODLE_DOCKER_DB is not set'
    exit 1
fi

# Nasty portable way to the directory of this script, following symlink,
# because readlink -f not on OSX. Thanks stack overflow..
SOURCE="${BASH_SOURCE[0]}"
while [ -h "$SOURCE" ]; do # resolve $SOURCE until the file is no longer a symlink
  DIR="$( cd -P "$( dirname "$SOURCE" )" && pwd )"
  SOURCE="$(readlink "$SOURCE")"
  [[ $SOURCE != /* ]] && SOURCE="$DIR/$SOURCE" # if $SOURCE was a relative symlink, we need to resolve it relative to the path where the symlink file was located
done
basedir="$( cd -P "$( dirname "$SOURCE" )/../" && pwd )"
echo ASSETDIR="${basedir}/assets" >> temp.env

dockercompose="nerdctl compose"
dockercompose="${dockercompose} -f ${basedir}/base.yml --env-file temp.env" 
dockercompose="${dockercompose} -f ${basedir}/service.mail.yml --env-file temp.env"

# PHP Version.
echo MOODLE_DOCKER_PHP_VERSION=${MOODLE_DOCKER_PHP_VERSION:-7.4} >> temp.env

# Database flavour
if [ "$MOODLE_DOCKER_DB" != 'pgsql' ];
then
    dockercompose="${dockercompose} -f ${basedir}/db.${MOODLE_DOCKER_DB}.yml --env-file temp.env"

fi

# Support PHP version overrides for DB..
filename="${basedir}/db.${MOODLE_DOCKER_DB}.${MOODLE_DOCKER_PHP_VERSION}.yml"
if [ -f $filename ]; then
    dockercompose="${dockercompose} -f ${filename} --env-file temp.env"
fi

# Fix mobile app deprecated variables
if [ ! -z "$MOODLE_APP_VERSION" ];
then
    echo 'Warning: $MOODLE_APP_VERSION is deprecated, use $MOODLE_DOCKER_APP_VERSION instead'

    if [ -z "$MOODLE_DOCKER_APP_VERSION" ];
    then
        echo MOODLE_DOCKER_APP_VERSION="$MOODLE_APP_VERSION" >> temp.env
    fi
fi

# Guess mobile app runtime
if [ -z "$MOODLE_DOCKER_APP_RUNTIME" ];
then
    if [[ ! -z "$MOODLE_DOCKER_APP_PATH" ]];
    then
        appversion="$(cat $MOODLE_DOCKER_APP_PATH/package.json | grep -oP '"version": "\K\d\.\d\.\d{1,2}(-\w+)?(?=")')"
    elif [[ ! -z "$MOODLE_DOCKER_APP_VERSION" ]];
    then
        appversion=$MOODLE_DOCKER_APP_VERSION
    fi

    if [[ ! -z $appversion ]];
    then
        if [[ ! -z "$(echo $appversion | grep -oP '\d\.\d\.\d{1,2}')" ]];
        then
            appmajorversion="$(echo $appversion | grep -oP '\d(?=\.\d\.\d{1,2})')"
            appminorversion="$(echo $appversion | grep -oP '\d\.\K\d(?=\.\d{1,2})')"
            apppatchversion="$(echo $appversion | grep -oP '\d\.\d\.\K\d{1,2}')"

            if (( $appmajorversion > 3 ));
            then
                echo MOODLE_DOCKER_APP_RUNTIME="ionic5" >> temp.env
            elif (( $appminorversion != 9));
            then
                echo MOODLE_DOCKER_APP_RUNTIME="ionic3" >> temp.env
            elif (( $apppatchversion < 5 ));
            then
                echo MOODLE_DOCKER_APP_RUNTIME="ionic3" >> temp.env
            else
                echo MOODLE_DOCKER_APP_RUNTIME="ionic5" >> temp.env
            fi
        else
            echo MOODLE_DOCKER_APP_RUNTIME="ionic5" >> temp.env
        fi
    fi
fi

# Mobile app for development
if [[ ! -z "$MOODLE_DOCKER_BROWSER" ]] && [[ "$MOODLE_DOCKER_BROWSER" == "chrome" ]] && [[ ! -z "$MOODLE_DOCKER_APP_PATH" ]];
then
    dockercompose="${dockercompose} -f ${basedir}/moodle-app-dev-$MOODLE_DOCKER_APP_RUNTIME.yml"

# Mobile app using a docker image
elif [[ ! -z "$MOODLE_DOCKER_BROWSER" ]] && [[ "$MOODLE_DOCKER_BROWSER" == "chrome" ]] && [[ ! -z "$MOODLE_DOCKER_APP_VERSION" ]];
then
    dockercompose="${dockercompose} -f ${basedir}/moodle-app-$MOODLE_DOCKER_APP_RUNTIME.yml"
fi

# Selenium browser
browserparts=(${MOODLE_DOCKER_BROWSER//:/ })
echo MOODLE_DOCKER_BROWSER_NAME=${browserparts[0]} >> temp.env
echo MOODLE_DOCKER_BROWSER_TAG=${browserparts[1]} >> temp.env

if [[ -z "$MOODLE_DOCKER_BROWSER_NAME" ]];
then
    MOODLE_DOCKER_BROWSER_NAME=firefox
fi

if [[ -z "$MOODLE_DOCKER_BROWSER_TAG" ]];
then
    if [[ "$MOODLE_DOCKER_BROWSER_NAME" = "firefox" ]];
    then
        MOODLE_DOCKER_BROWSER_TAG=3
    elif [[ "$MOODLE_DOCKER_BROWSER_NAME" = "chrome" ]];
    then
        MOODLE_DOCKER_BROWSER_TAG=3
    fi
fi

if [[ "$MOODLE_DOCKER_BROWSER_NAME" != "firefox" ]];
then
    dockercompose="${dockercompose} -f ${basedir}/selenium.${MOODLE_DOCKER_BROWSER_NAME}.yml --env-file temp.env"
fi

# Selenium VNC port
# echo  MOODLE_DOCKER_SELENIUM_SUFFIX="" >> temp.env
if [[ $MOODLE_DOCKER_SELENIUM_VNC_PORT == *":"* ]] || [[ $MOODLE_DOCKER_SELENIUM_VNC_PORT -gt 0 ]]
then
    # echo MOODLE_DOCKER_SELENIUM_SUFFIX="-debug" >> temp.env
    # If no bind ip has been configured (bind_ip:port), default to 127.0.0.1
    if [[ ! $MOODLE_DOCKER_SELENIUM_VNC_PORT == *":"* ]]
    then
        MOODLE_DOCKER_SELENIUM_VNC_PORT=127.0.0.1:$MOODLE_DOCKER_SELENIUM_VNC_PORT
    fi
    dockercompose="${dockercompose} -f ${basedir}/selenium.debug.yml --env-file temp.env"
fi

# External services
if [[ ! -z "$MOODLE_DOCKER_PHPUNIT_EXTERNAL_SERVICES" ]];
then
    dockercompose="${dockercompose} -f ${basedir}/phpunit-external-services.yml --env-file temp.env"
fi

#  Faildump directory
if [[ ! -z "$MOODLE_DOCKER_BEHAT_FAILDUMP" ]];
then
    if [ ! -d "$MOODLE_DOCKER_BEHAT_FAILDUMP" ];
    then
        echo 'Error: $MOODLE_DOCKER_BEHAT_FAILDUMP is not an existing directory'
        exit 1
    fi
    dockercompose="${dockercompose} -f ${basedir}/behat-faildump.yml --env-file temp.env"
fi

# Webserver host
echo MOODLE_DOCKER_WEB_HOST=${MOODLE_DOCKER_WEB_HOST:-localhost} >> temp.env

# Webserver port
echo MOODLE_DOCKER_WEB_PORT=${MOODLE_DOCKER_WEB_PORT:-8000} >> temp.env
if [[ $MOODLE_DOCKER_WEB_PORT == *":"* ]] || [[ $MOODLE_DOCKER_WEB_PORT -gt 0 ]]
then
    # If no bind ip has been configured (bind_ip:port), default to 127.0.0.1
    if [[ ! $MOODLE_DOCKER_WEB_PORT == *":"* ]]
    then
        MOODLE_DOCKER_WEB_PORT=127.0.0.1:$MOODLE_DOCKER_WEB_PORT
    fi
    dockercompose="${dockercompose} -f ${basedir}/webserver.port.yml --env-file temp.env"
fi


# Mac OS Compatbility
# if [[ "$(uname)" == "Darwin" ]]; then
#     # Support https://docs.docker.com/docker-for-mac/osxfs-caching/
#     dockercompose="${dockercompose} -f ${basedir}/volumes-cached.yml --env-file temp.env"
# fi


$dockercompose "$@"
